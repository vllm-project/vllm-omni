steps:
  # - label: ":docker: Build image"
  #   key: image-build
  #   commands:
  #     - "aws ecr-public get-login-password --region us-east-1 | docker login --username AWS --password-stdin public.ecr.aws/q9t5s3a7"
  #     - "docker build --file docker/Dockerfile.ci -t vllm-omni-ci ."
  #     - "docker tag vllm-omni-ci public.ecr.aws/q9t5s3a7/vllm-ci-test-repo:$BUILDKITE_COMMIT-gpu"
  #     - "docker push public.ecr.aws/q9t5s3a7/vllm-ci-test-repo:$BUILDKITE_COMMIT-gpu"
  #   agents:
  #     queue: "cpu_queue_premerge_us_east_1"

  - label: ":docker: Build NPU image"
    key: npu-image-build
    commands:
      - "aws ecr-public get-login-password --region us-east-1 | docker login --username AWS --password-stdin public.ecr.aws/q9t5s3a7"
      - "docker build --file docker/Dockerfile.npu -t vllm-omni-ci-npu ."
      - "docker tag vllm-omni-ci-npu public.ecr.aws/q9t5s3a7/vllm-ci-test-repo:$BUILDKITE_COMMIT-npu"
      - "docker push public.ecr.aws/q9t5s3a7/vllm-ci-test-repo:$BUILDKITE_COMMIT-npu"
    agents:
      queue: "cpu_queue_premerge_us_east_1"

  # - label: "Simple Unit Test"
  #   commands:
  #     - ".buildkite/scripts/simple_test.sh"
  #   agents:
  #     queue: "cpu_queue_premerge"

  # - label: "Diffusion Model Test"
  #   timeout_in_minutes: 15
  #   depends_on: image-build
  #   commands:
  #     - pytest -s -v tests/single_stage/test_diffusion_model.py
  #   agents:
  #     queue: "gpu_1_queue" # g6.4xlarge instance on AWS, has 1 L4 GPU
  #   plugins:
  #     - docker#v5.2.0:
  #         image: public.ecr.aws/q9t5s3a7/vllm-ci-test-repo:$BUILDKITE_COMMIT
  #         always-pull: true
  #         propagate-environment: true
  #         environment:
  #           - "HF_HOME=/fsx/hf_cache"
  #         volumes:
  #           - "/fsx/hf_cache:/fsx/hf_cache"

  # - label: "Omni Model Test"
  #   timeout_in_minutes: 15
  #   depends_on: image-build
  #   commands:
  #     - export VLLM_LOGGING_LEVEL=DEBUG
  #     - export VLLM_WORKER_MULTIPROC_METHOD=spawn
  #     - pytest -s -v tests/multi_stages/
  #   agents:
  #     queue: "gpu_4_queue" # g6.4xlarge instance on AWS, has 1 L4 GPU
  #   plugins:
  #     - docker#v5.2.0:
  #         image: public.ecr.aws/q9t5s3a7/vllm-ci-test-repo:$BUILDKITE_COMMIT
  #         always-pull: true
  #         propagate-environment: true
  #         environment:
  #           - "HF_HOME=/fsx/hf_cache"
  #         volumes:
  #           - "/fsx/hf_cache:/fsx/hf_cache"

  - label: "Simple Unit Test"
    timeout_in_minutes: 15
    depends_on: npu-image-build
    commands:
      - ".buildkite/scripts/simple_test.sh"
    agents:
      queue: "ascend"
    plugins:
      - docker#v5.2.0:
          image: public.ecr.aws/q9t5s3a7/vllm-ci-test-repo:$BUILDKITE_COMMIT-npu
          always-pull: true
          propagate-environment: true
          environment:
            - "HF_ENDPOINT=https://hf-mirror.com"
            - "HF_HOME=/mnt/huggingface"
          volumes:
            - "/mnt/huggingface:/mnt/huggingface"